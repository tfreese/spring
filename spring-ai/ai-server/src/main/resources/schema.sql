DROP TABLE IF EXISTS ORDER_ITEM;
DROP TABLE IF EXISTS ORDERS;
DROP TABLE IF EXISTS CUSTOMER;

CREATE TABLE CUSTOMER
(
    CUSTOMER_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CUSTOMER_NO VARCHAR(20)  NOT NULL UNIQUE,
    NAME        VARCHAR(200) NOT NULL,
    EMAIL       VARCHAR(255),
    CREATED_AT  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE ORDERS
(
    ORDER_ID    BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CUSTOMER_ID BIGINT      NOT NULL,
    ORDER_NO    VARCHAR(30) NOT NULL UNIQUE,
    ORDER_DATE  DATE        NOT NULL DEFAULT CURRENT_DATE,
    STATUS      VARCHAR(20) NOT NULL DEFAULT 'NEW',

    CONSTRAINT FK_ORDERS_CUSTOMER
        FOREIGN KEY (CUSTOMER_ID)
            REFERENCES CUSTOMER (CUSTOMER_ID)
            ON DELETE RESTRICT
            ON UPDATE RESTRICT
);

CREATE TABLE ORDER_ITEM
(
    ORDER_ITEM_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ID      BIGINT         NOT NULL,
    POSITION_NO   INT            NOT NULL,
    PRODUCT_CODE  VARCHAR(50)    NOT NULL,
    QUANTITY      INT            NOT NULL CHECK (QUANTITY > 0),
    UNIT_PRICE    DECIMAL(12, 2) NOT NULL CHECK (UNIT_PRICE >= 0),

    CONSTRAINT UQ_ORDERITEM_ORDER_POS
        UNIQUE (ORDER_ID, POSITION_NO),

    CONSTRAINT FK_ORDERITEM_ORDERS
        FOREIGN KEY (ORDER_ID)
            REFERENCES ORDERS (ORDER_ID)
            ON DELETE CASCADE
            ON UPDATE RESTRICT
);

CREATE INDEX IF NOT EXISTS IX_ORDERS_CUSTOMER_ID ON ORDERS (CUSTOMER_ID);
CREATE INDEX IF NOT EXISTS IX_ORDERITEM_ORDER_ID ON ORDER_ITEM (ORDER_ID);
